# Voltaxe YARA Malware Detection - Implementation Guide

## Overview

Voltaxe now includes YARA-based malware detection capabilities! This feature allows you to scan files for malware signatures, including the EICAR test file and various malicious patterns like:

- **Ransomware** indicators
- **Cryptocurrency miners**
- **Reverse shells** and backdoors
- **Keyloggers**
- **PowerShell** malicious patterns
- **SSH key theft** attempts
- **File wipers**
- **And more!**

## üéØ Quick Start

### 1. Rebuild the API Container

The malware scanner requires the `yara-python` library. Rebuild the API container to install it:

```bash
cd /home/rahul/Voltaxe/Voltaxe

# Rebuild just the API service
docker-compose build clarity_hub_api

# Restart the container
docker-compose up -d clarity_hub_api
```

Or use the convenience script:

```bash
./run.sh build
./run.sh restart
```

### 2. Test EICAR Detection

Once the container is running, test the malware scanner with the EICAR test file:

```bash
# Using curl (you'll need to login first to get a token)
curl -X GET "http://localhost:8000/malware/test-eicar" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

Or visit the API docs at `http://localhost:8000/docs` and use the interactive UI to test the `/malware/test-eicar` endpoint.

## üìÇ What Was Added

### 1. YARA Rules (`/services/clarity_hub_api/malware_scanner/rules.yar`)

A comprehensive set of YARA rules including:

- **EICAR Test File Detection** - Standard antivirus test
- **Suspicious PowerShell** - Malicious PowerShell download patterns
- **Base64 Encoded PowerShell** - Obfuscated scripts
- **Reverse Shells** - Common backdoor patterns
- **Cryptocurrency Miners** - Mining malware detection
- **Ransomware** - File encryption indicators
- **Registry Persistence** - Malicious startup entries
- **Mass File Deletion** - Wiper malware
- **SSH Key Theft** - Credential theft attempts
- **Keyloggers** - Keystroke logging malware

### 2. Malware Scanner Module (`/services/clarity_hub_api/malware_scanner/`)

Python module with:
- `scanner.py` - Main scanner implementation with YARA integration
- `__init__.py` - Module exports
- `rules.yar` - YARA signature database

### 3. API Endpoints

New malware scanning endpoints added to `/services/clarity_hub_api/main.py`:

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/malware/scan` | POST | Upload and scan a file for malware |
| `/malware/test-eicar` | GET | Test scanner with EICAR test file |
| `/malware/scans` | GET | Get malware scan history |
| `/malware/scans/{scan_id}` | GET | Get specific scan details |
| `/malware/summary` | GET | Get scan statistics and summary |
| `/malware/rules` | GET | List all loaded YARA rules |
| `/malware/reload-rules` | POST | Reload YARA rules without restart |

### 4. Database Schema

New table `malware_scans` with fields:
- File metadata (name, size, hashes)
- Scan results (malicious status, threat level)
- YARA rule matches
- Timestamps and user info

## üîß Usage Examples

### Scan a File via API

```python
import requests

# Login first
response = requests.post(
    "http://localhost:8000/auth/login",
    json={"email": "user@example.com", "password": "password"}
)
token = response.json()["access_token"]

# Upload and scan a file
files = {"file": open("suspicious_file.exe", "rb")}
headers = {"Authorization": f"Bearer {token}"}

response = requests.post(
    "http://localhost:8000/malware/scan",
    files=files,
    headers=headers
)

scan_result = response.json()
print(f"Malicious: {scan_result['is_malicious']}")
print(f"Threat Level: {scan_result['threat_level']}")
print(f"Matches: {len(scan_result['matches'])}")
```

### Get Scan History

```python
response = requests.get(
    "http://localhost:8000/malware/scans?limit=50&malicious_only=true",
    headers={"Authorization": f"Bearer {token}"}
)

scans = response.json()
for scan in scans:
    print(f"{scan['file_name']}: {scan['threat_level']}")
```

### Get Summary Statistics

```python
response = requests.get(
    "http://localhost:8000/malware/summary",
    headers={"Authorization": f"Bearer {token}"}
)

summary = response.json()
print(f"Total Scans: {summary['total_scans']}")
print(f"Malicious Files: {summary['malicious_files']}")
print(f"Threat Distribution: {summary['threat_distribution']}")
```

## üìä Understanding Scan Results

### Threat Levels

- **clean** - No malware detected
- **low** - Minor suspicious patterns
- **medium** - Potentially unwanted program (PUP)
- **high** - Likely malware
- **critical** - Confirmed malware (e.g., ransomware, backdoor)

### YARA Match Structure

Each scan returns matched YARA rules:

```json
{
  "rule_name": "EICAR_Test_File",
  "description": "EICAR Anti-Virus Test File",
  "severity": "high",
  "malware_type": "test_file",
  "tags": [],
  "strings": [
    {
      "identifier": "$eicar_string",
      "instances": [
        {
          "offset": 0,
          "matched_data": "X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR..."
        }
      ]
    }
  ]
}
```

## üõ°Ô∏è EICAR Test File

The **EICAR** (European Institute for Computer Antivirus Research) test file is a standard way to test antivirus and anti-malware systems without using actual malware.

### What is EICAR?

- **Safe**: Not actual malware, just a test signature
- **Standard**: Recognized by all major antivirus vendors
- **Purpose**: Verify malware detection is working correctly

### EICAR Test String

```
X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*
```

### Testing with EICAR

1. **Via API**: Use `/malware/test-eicar` endpoint (recommended)
2. **Upload File**: Create a text file with the EICAR string and upload via `/malware/scan`
3. **Command Line**: 
   ```bash
   echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > eicar.com
   # Then upload via API
   ```

**Expected Result**: Should detect as malicious with `threat_level: "high"` and match the `EICAR_Test_File` rule.

## üìã File Hash Calculation

Each scanned file gets three hash values calculated:

- **MD5** - Fast but outdated
- **SHA1** - Better than MD5
- **SHA256** - Current standard, most secure

These hashes allow you to:
- Track unique files
- Search for known malware hashes
- Compare with threat intelligence databases
- Detect file modifications

## üîÑ Adding Custom YARA Rules

You can add your own YARA rules to enhance detection:

### 1. Edit the Rules File

```bash
# Edit the rules file (inside container or on host)
nano /home/rahul/Voltaxe/Voltaxe/services/clarity_hub_api/malware_scanner/rules.yar
```

### 2. Add Your Rule

```yara
rule My_Custom_Malware {
    meta:
        description = "Detects my custom malware pattern"
        author = "Security Team"
        date = "2025-01-03"
        severity = "critical"
        malware_type = "backdoor"
    
    strings:
        $pattern1 = "malicious_string_here"
        $pattern2 = { 6A 40 68 00 30 00 00 }  // Hex pattern
    
    condition:
        $pattern1 or $pattern2
}
```

### 3. Reload Rules

```bash
# Via API
curl -X POST "http://localhost:8000/malware/reload-rules" \
  -H "Authorization: Bearer YOUR_TOKEN"

# Or restart the container
docker-compose restart clarity_hub_api
```

## üìñ YARA Resources

- **Official Docs**: https://yara.readthedocs.io/
- **Writing Rules**: https://yara.readthedocs.io/en/stable/writingrules.html
- **Rule Repository**: https://github.com/Yara-Rules/rules
- **Community Rules**: https://github.com/InQuest/awesome-yara

## üöÄ Advanced Usage

### Batch Scanning

Scan multiple files programmatically:

```python
import os
import requests

token = "YOUR_TOKEN"
headers = {"Authorization": f"Bearer {token}"}

for filename in os.listdir("/path/to/files"):
    with open(f"/path/to/files/{filename}", "rb") as f:
        files = {"file": (filename, f)}
        response = requests.post(
            "http://localhost:8000/malware/scan",
            files=files,
            headers=headers
        )
        result = response.json()
        if result["is_malicious"]:
            print(f"‚ö†Ô∏è {filename}: {result['threat_level']}")
```

### Integration with Endpoints

Scan files from monitored endpoints:

```python
# When ingesting a suspicious event with a file path
response = requests.post(
    "http://localhost:8000/malware/scan",
    files={"file": open(suspicious_file_path, "rb")},
    params={"hostname": endpoint_hostname},
    headers=headers
)
```

### Automated Alerts

Set up alerts for malware detection:

```python
response = requests.get(
    "http://localhost:8000/malware/scans?malicious_only=true",
    headers=headers
)

for scan in response.json():
    if scan["threat_level"] in ["high", "critical"]:
        # Send alert via email, Slack, etc.
        send_alert(f"Critical malware detected: {scan['file_name']}")
```

## üêõ Troubleshooting

### Scanner Not Available

**Error**: `Malware scanner is not available. YARA library may not be installed.`

**Solution**:
```bash
# Rebuild the API container
cd /home/rahul/Voltaxe/Voltaxe
docker-compose build clarity_hub_api
docker-compose up -d clarity_hub_api

# Check logs
docker-compose logs clarity_hub_api
```

### YARA Rules Not Loading

**Error**: `Failed to load YARA rules`

**Solutions**:
1. Check rules file syntax:
   ```bash
   docker exec -it voltaxe-clarity_hub_api-1 python3 -c "import yara; yara.compile(filepath='/app/malware_scanner/rules.yar')"
   ```

2. Validate YARA syntax at: https://yara-ci.cloud.virustotal.com/

3. Check file permissions:
   ```bash
   ls -la /home/rahul/Voltaxe/Voltaxe/services/clarity_hub_api/malware_scanner/
   ```

### File Upload Fails

**Error**: `File too large`

**Solution**: The default limit is 100MB. To increase:

1. Edit `main.py` and change `max_size` in the `/malware/scan` endpoint
2. Update nginx configuration if using a reverse proxy
3. Restart containers

## üéì Next Steps

1. **Test EICAR** - Verify detection works with `/malware/test-eicar`
2. **Scan Real Files** - Upload suspicious files via `/malware/scan`
3. **Review Rules** - Check available rules at `/malware/rules`
4. **Add Custom Rules** - Enhance detection with your own patterns
5. **Integrate with Frontend** - Build UI for file upload and scan visualization
6. **Set Up Alerts** - Configure notifications for malware detection
7. **Connect to Threat Intel** - Integrate hash lookups with VirusTotal or other services

## üìù API Documentation

Full API documentation is available at:
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

## üîí Security Considerations

- **File Size Limits**: Default 100MB to prevent DoS
- **Authentication Required**: All endpoints require valid JWT token
- **Scan History**: All scans are logged with user attribution
- **No File Storage**: Files are scanned in memory and not saved (unless you modify the code)
- **YARA Rules**: Regularly update rules to detect new threats

## ‚úÖ Success Checklist

- [ ] Rebuilt API container with yara-python
- [ ] Container started successfully
- [ ] EICAR test returns malicious detection
- [ ] Can upload and scan files
- [ ] Scan history displays correctly
- [ ] Custom YARA rules added (optional)
- [ ] Frontend integration planned (optional)

## üìû Support

For issues or questions:
1. Check container logs: `docker-compose logs clarity_hub_api`
2. Verify YARA installation: `docker exec voltaxe-clarity_hub_api-1 python3 -c "import yara; print(yara.__version__)"`
3. Test API health: `curl http://localhost:8000/health`

---

**Congratulations!** üéâ You now have YARA-based malware detection running in Voltaxe!
