#!/usr/bin/env python3
"""
Test Voltaxe YARA Malware Scanner
Tests EICAR detection and basic malware scanning functionality
"""

import requests
import json
from datetime import datetime
import os

# API Configuration - Use environment variables for CI/CD compatibility
# In CI/CD (e.g., GitHub Actions), set API_URL=http://voltaxe_api:8000
# For local development, defaults to http://localhost:8000
API_URL = os.getenv("API_URL", "http://localhost:8000")

def print_section(title):
    """Print formatted section header"""
    print(f"\n{'='*60}")
    print(f"  {title}")
    print(f"{'='*60}\n")

def print_result(label, value, color=""):
    """Print formatted result"""
    colors = {
        "green": "\033[92m",
        "red": "\033[91m",
        "yellow": "\033[93m",
        "blue": "\033[94m",
        "end": "\033[0m"
    }
    c = colors.get(color, "")
    end = colors["end"] if c else ""
    print(f"{label}: {c}{value}{end}")

def test_health():
    """Test API health endpoint"""
    print_section("Testing API Health")
    
    try:
        response = requests.get(f"{API_URL}/health")
        if response.status_code == 200:
            data = response.json()
            print_result("Status", data["status"], "green")
            print_result("Service", data["service"], "blue")
            print_result("Version", data["version"], "blue")
            return True
        else:
            print_result("Status", f"Failed ({response.status_code})", "red")
            return False
    except Exception as e:
        print_result("Error", str(e), "red")
        return False

def login():
    """Login and get access token"""
    print_section("Authenticating")
    
    # Try to register a test user
    try:
        response = requests.post(
            f"{API_URL}/auth/register",
            json={
                "email": "malware_tester@voltaxe.local",
                "password": "MalwareTest2025!",
                "username": "malware_tester"
            }
        )
        if response.status_code == 200:
            print_result("Registration", "New user created", "green")
        else:
            print_result("Registration", "User may already exist", "yellow")
    except Exception as e:
        print_result("Registration", f"Skipped: {e}", "yellow")
    
    # Login
    try:
        response = requests.post(
            f"{API_URL}/auth/login",
            json={
                "email": "malware_tester@voltaxe.local",
                "password": "MalwareTest2025!"
            }
        )
        
        if response.status_code == 200:
            data = response.json()
            token = data["access_token"]
            print_result("Login", "Success ‚úì", "green")
            print_result("Token", f"{token[:20]}...", "blue")
            return token
        else:
            print_result("Login", f"Failed ({response.status_code})", "red")
            print(response.text)
            return None
    except Exception as e:
        print_result("Error", str(e), "red")
        return None

def test_eicar(token):
    """Test EICAR malware detection"""
    print_section("Testing EICAR Detection")
    
    if not token:
        print_result("Error", "No authentication token", "red")
        return False
    
    try:
        headers = {"Authorization": f"Bearer {token}"}
        response = requests.get(f"{API_URL}/malware/test-eicar", headers=headers)
        
        if response.status_code == 200:
            data = response.json()
            
            print_result("Scan ID", data["scan_id"], "blue")
            print_result("File Name", data["file_name"], "blue")
            print_result("File Size", f"{data['file_size']} bytes", "blue")
            print_result("MD5 Hash", data["md5_hash"], "blue")
            print_result("SHA256 Hash", data["sha256_hash"], "blue")
            
            # Check detection
            is_malicious = data["is_malicious"]
            threat_level = data["threat_level"]
            matches = data["matches"]
            
            print()
            if is_malicious:
                print_result("Detection", "MALICIOUS ‚ö†Ô∏è", "red")
            else:
                print_result("Detection", "Clean", "green")
            
            print_result("Threat Level", threat_level.upper(), 
                        "red" if threat_level in ["high", "critical"] else "yellow")
            print_result("Matches", len(matches), "blue")
            
            # Show matched rules
            if matches:
                print("\nMatched YARA Rules:")
                for match in matches:
                    print(f"  ‚Ä¢ {match['rule_name']}")
                    print(f"    Description: {match['description']}")
                    print(f"    Severity: {match['severity']}")
                    print(f"    Type: {match['malware_type']}")
                    print()
            
            # Verify EICAR was detected
            if is_malicious and any(m["rule_name"].startswith("EICAR") for m in matches):
                print_result("EICAR Test", "PASSED ‚úì", "green")
                return True
            else:
                print_result("EICAR Test", "FAILED ‚úó", "red")
                return False
        else:
            print_result("Error", f"HTTP {response.status_code}", "red")
            print(response.text)
            return False
    
    except Exception as e:
        print_result("Error", str(e), "red")
        return False

def test_malware_rules(token):
    """Test getting available YARA rules"""
    print_section("Available YARA Rules")
    
    if not token:
        print_result("Error", "No authentication token", "red")
        return False
    
    try:
        headers = {"Authorization": f"Bearer {token}"}
        response = requests.get(f"{API_URL}/malware/rules", headers=headers)
        
        if response.status_code == 200:
            data = response.json()
            total_rules = data["total_rules"]
            rules = data["rules"]
            
            print_result("Total Rules", total_rules, "green")
            print("\nRule List:")
            
            for rule in rules[:10]:  # Show first 10
                rule_name = rule.get("rule_name", "Unknown")
                description = rule.get("description", "No description")
                severity = rule.get("severity", "unknown")
                
                print(f"\n  {rule_name}")
                print(f"  ‚îú‚îÄ Description: {description}")
                print(f"  ‚îî‚îÄ Severity: {severity}")
            
            if len(rules) > 10:
                print(f"\n  ... and {len(rules) - 10} more rules")
            
            return True
        else:
            print_result("Error", f"HTTP {response.status_code}", "red")
            return False
    
    except Exception as e:
        print_result("Error", str(e), "red")
        return False

def test_scan_summary(token):
    """Test getting scan summary"""
    print_section("Malware Scan Summary")
    
    if not token:
        print_result("Error", "No authentication token", "red")
        return False
    
    try:
        headers = {"Authorization": f"Bearer {token}"}
        response = requests.get(f"{API_URL}/malware/summary", headers=headers)
        
        if response.status_code == 200:
            data = response.json()
            
            print_result("Total Scans", data["total_scans"], "blue")
            print_result("Malicious Files", data["malicious_files"], "red")
            print_result("Clean Files", data["clean_files"], "green")
            
            print("\nThreat Distribution:")
            for level, count in data["threat_distribution"].items():
                if count > 0:
                    color = "red" if level in ["high", "critical"] else "yellow" if level == "medium" else "green"
                    print_result(f"  {level.title()}", count, color)
            
            recent = data["recent_threats"]
            if recent:
                print(f"\nRecent Threats ({len(recent)}):")
                for threat in recent[:5]:
                    print(f"  ‚Ä¢ {threat['file_name']} - {threat['threat_level'].upper()}")
            
            return True
        else:
            print_result("Error", f"HTTP {response.status_code}", "red")
            return False
    
    except Exception as e:
        print_result("Error", str(e), "red")
        return False

def main():
    """Main test runner"""
    print("\n" + "="*60)
    print("  üõ°Ô∏è  VOLTAXE YARA MALWARE SCANNER TEST SUITE")
    print("="*60)
    print(f"  Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"  API: {API_URL}")
    print("="*60)
    
    # Run tests
    results = {}
    
    # Test 1: Health check
    results["health"] = test_health()
    
    # Test 2: Authentication
    token = login()
    results["auth"] = token is not None
    
    if token:
        # Test 3: EICAR detection
        results["eicar"] = test_eicar(token)
        
        # Test 4: YARA rules
        results["rules"] = test_malware_rules(token)
        
        # Test 5: Scan summary
        results["summary"] = test_scan_summary(token)
    
    # Print final results
    print_section("Test Results Summary")
    
    passed = sum(1 for v in results.values() if v)
    total = len(results)
    
    for test_name, result in results.items():
        status = "PASS ‚úì" if result else "FAIL ‚úó"
        color = "green" if result else "red"
        print_result(f"{test_name.title()}", status, color)
    
    print()
    print_result("Overall", f"{passed}/{total} tests passed", 
                "green" if passed == total else "yellow")
    
    if passed == total:
        print("\nüéâ All tests passed! Malware scanner is working correctly.")
    else:
        print(f"\n‚ö†Ô∏è  {total - passed} test(s) failed. Please check the errors above.")
    
    print("\n" + "="*60 + "\n")

if __name__ == "__main__":
    main()
