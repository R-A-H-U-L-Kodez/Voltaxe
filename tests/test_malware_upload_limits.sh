#!/bin/bash
# Automated test suite for malware scanner input validation
# Tests memory-safe file upload with size limits

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuration
API_URL="${API_URL:-http://localhost/api}"
TOKEN="${TOKEN:-}"
TEMP_DIR="/tmp/voltaxe_malware_tests"

# Test counters
TESTS_PASSED=0
TESTS_FAILED=0
TESTS_TOTAL=0

# Helper functions
log_info() {
    echo -e "${YELLOW}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[PASS]${NC} $1"
    ((TESTS_PASSED++))
}

log_error() {
    echo -e "${RED}[FAIL]${NC} $1"
    ((TESTS_FAILED++))
}

check_prerequisites() {
    log_info "Checking prerequisites..."
    
    # Check if curl is installed
    if ! command -v curl &> /dev/null; then
        echo "Error: curl is not installed"
        exit 1
    fi
    
    # Check if dd is installed
    if ! command -v dd &> /dev/null; then
        echo "Error: dd is not installed"
        exit 1
    fi
    
    # Check if API is reachable
    if ! curl -s -o /dev/null -w "%{http_code}" "$API_URL/health" | grep -q "200"; then
        echo "Warning: API may not be reachable at $API_URL"
    fi
    
    # Create temp directory
    mkdir -p "$TEMP_DIR"
    
    log_info "Prerequisites checked ✓"
}

cleanup() {
    log_info "Cleaning up temporary files..."
    rm -rf "$TEMP_DIR"
}

# Test 1: Normal file upload (should succeed)
test_normal_upload() {
    ((TESTS_TOTAL++))
    log_info "Test 1: Normal file upload (10MB)"
    
    # Create 10MB test file
    dd if=/dev/urandom of="$TEMP_DIR/test_10mb.bin" bs=1M count=10 2>/dev/null
    
    # Upload file
    response=$(curl -s -w "\n%{http_code}" \
        -X POST "$API_URL/malware/scan" \
        -H "Authorization: Bearer $TOKEN" \
        -F "file=@$TEMP_DIR/test_10mb.bin")
    
    http_code=$(echo "$response" | tail -n1)
    body=$(echo "$response" | sed '$d')
    
    if [ "$http_code" = "200" ]; then
        log_success "Normal upload accepted (HTTP 200)"
        
        # Verify response contains scan results
        if echo "$body" | grep -q "file_size"; then
            log_success "Response contains scan results"
        else
            log_error "Response missing scan results"
        fi
    else
        log_error "Expected HTTP 200, got $http_code"
        echo "Response: $body"
    fi
}

# Test 2: Oversized file (should be rejected by nginx)
test_oversized_upload() {
    ((TESTS_TOTAL++))
    log_info "Test 2: Oversized file upload (150MB)"
    
    # Create 150MB test file
    dd if=/dev/urandom of="$TEMP_DIR/test_150mb.bin" bs=1M count=150 2>/dev/null
    
    # Upload file
    response=$(curl -s -w "\n%{http_code}" \
        -X POST "$API_URL/malware/scan" \
        -H "Authorization: Bearer $TOKEN" \
        -F "file=@$TEMP_DIR/test_150mb.bin")
    
    http_code=$(echo "$response" | tail -n1)
    body=$(echo "$response" | sed '$d')
    
    if [ "$http_code" = "413" ]; then
        log_success "Oversized upload rejected (HTTP 413)"
    else
        log_error "Expected HTTP 413, got $http_code"
        echo "Response: $body"
    fi
}

# Test 3: Large file within limits (should use streaming)
test_large_file_streaming() {
    ((TESTS_TOTAL++))
    log_info "Test 3: Large file within limits (80MB)"
    
    # Create 80MB test file
    dd if=/dev/urandom of="$TEMP_DIR/test_80mb.bin" bs=1M count=80 2>/dev/null
    
    # Upload file and measure time
    start_time=$(date +%s)
    response=$(curl -s -w "\n%{http_code}" \
        -X POST "$API_URL/malware/scan" \
        -H "Authorization: Bearer $TOKEN" \
        -F "file=@$TEMP_DIR/test_80mb.bin")
    end_time=$(date +%s)
    
    http_code=$(echo "$response" | tail -n1)
    body=$(echo "$response" | sed '$d')
    duration=$((end_time - start_time))
    
    if [ "$http_code" = "200" ]; then
        log_success "Large file uploaded successfully (HTTP 200, ${duration}s)"
        
        # Verify no OOM kill (check if response is valid JSON)
        if echo "$body" | python3 -m json.tool > /dev/null 2>&1; then
            log_success "Valid JSON response (no OOM kill)"
        else
            log_error "Invalid JSON response (possible OOM)"
        fi
    else
        log_error "Expected HTTP 200, got $http_code"
        echo "Response: $body"
    fi
}

# Test 4: EICAR test file (should detect malware)
test_eicar_detection() {
    ((TESTS_TOTAL++))
    log_info "Test 4: EICAR malware detection"
    
    # Create EICAR test file
    echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > "$TEMP_DIR/eicar.txt"
    
    # Upload file
    response=$(curl -s -w "\n%{http_code}" \
        -X POST "$API_URL/malware/scan" \
        -H "Authorization: Bearer $TOKEN" \
        -F "file=@$TEMP_DIR/eicar.txt")
    
    http_code=$(echo "$response" | tail -n1)
    body=$(echo "$response" | sed '$d')
    
    if [ "$http_code" = "200" ]; then
        log_success "EICAR file uploaded (HTTP 200)"
        
        # Check if detected as malicious
        if echo "$body" | grep -q '"is_malicious":true'; then
            log_success "EICAR detected as malicious"
        else
            log_error "EICAR not detected as malicious"
            echo "Response: $body"
        fi
    else
        log_error "Expected HTTP 200, got $http_code"
        echo "Response: $body"
    fi
}

# Test 5: Empty file (edge case)
test_empty_file() {
    ((TESTS_TOTAL++))
    log_info "Test 5: Empty file upload"
    
    # Create empty file
    touch "$TEMP_DIR/empty.bin"
    
    # Upload file
    response=$(curl -s -w "\n%{http_code}" \
        -X POST "$API_URL/malware/scan" \
        -H "Authorization: Bearer $TOKEN" \
        -F "file=@$TEMP_DIR/empty.bin")
    
    http_code=$(echo "$response" | tail -n1)
    body=$(echo "$response" | sed '$d')
    
    if [ "$http_code" = "200" ]; then
        log_success "Empty file handled gracefully (HTTP 200)"
    else
        log_error "Expected HTTP 200, got $http_code"
        echo "Response: $body"
    fi
}

# Test 6: Concurrent uploads (stress test)
test_concurrent_uploads() {
    ((TESTS_TOTAL++))
    log_info "Test 6: Concurrent uploads (5 files)"
    
    # Create 5 test files
    for i in {1..5}; do
        dd if=/dev/urandom of="$TEMP_DIR/concurrent_${i}.bin" bs=1M count=5 2>/dev/null &
    done
    wait
    
    # Upload all files concurrently
    success_count=0
    for i in {1..5}; do
        response=$(curl -s -w "\n%{http_code}" \
            -X POST "$API_URL/malware/scan" \
            -H "Authorization: Bearer $TOKEN" \
            -F "file=@$TEMP_DIR/concurrent_${i}.bin") &
        
        # Store PID for later
        pids[${i}]=$!
    done
    
    # Wait for all uploads to complete
    for pid in ${pids[*]}; do
        wait $pid
        if [ $? -eq 0 ]; then
            ((success_count++))
        fi
    done
    
    if [ $success_count -eq 5 ]; then
        log_success "All 5 concurrent uploads succeeded"
    else
        log_error "Only $success_count/5 concurrent uploads succeeded"
    fi
}

# Test 7: File with special characters in name
test_special_filename() {
    ((TESTS_TOTAL++))
    log_info "Test 7: File with special characters in name"
    
    # Create file with special characters
    dd if=/dev/urandom of="$TEMP_DIR/test file (with) [special] {chars}.bin" bs=1M count=1 2>/dev/null
    
    # Upload file
    response=$(curl -s -w "\n%{http_code}" \
        -X POST "$API_URL/malware/scan" \
        -H "Authorization: Bearer $TOKEN" \
        -F "file=@$TEMP_DIR/test file (with) [special] {chars}.bin")
    
    http_code=$(echo "$response" | tail -n1)
    
    if [ "$http_code" = "200" ]; then
        log_success "Special filename handled correctly (HTTP 200)"
    else
        log_error "Expected HTTP 200, got $http_code"
    fi
}

# Main execution
main() {
    echo "========================================"
    echo "Malware Scanner Input Validation Tests"
    echo "========================================"
    echo ""
    
    check_prerequisites
    
    # Run all tests
    test_normal_upload
    test_oversized_upload
    test_large_file_streaming
    test_eicar_detection
    test_empty_file
    test_concurrent_uploads
    test_special_filename
    
    # Cleanup
    cleanup
    
    # Print summary
    echo ""
    echo "========================================"
    echo "Test Summary"
    echo "========================================"
    echo -e "Total Tests: $TESTS_TOTAL"
    echo -e "${GREEN}Passed: $TESTS_PASSED${NC}"
    echo -e "${RED}Failed: $TESTS_FAILED${NC}"
    echo ""
    
    if [ $TESTS_FAILED -eq 0 ]; then
        echo -e "${GREEN}✅ All tests passed!${NC}"
        exit 0
    else
        echo -e "${RED}❌ Some tests failed${NC}"
        exit 1
    fi
}

# Trap cleanup on exit
trap cleanup EXIT

# Run main
main
