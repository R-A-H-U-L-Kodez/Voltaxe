import React, { useState } from 'react';
import { Sidebar } from '../components/Sidebar';
import { MalwareStats } from '../components/MalwareStats';
import { MalwareScanHistory } from '../components/MalwareScanHistory';
import { Shield, Upload, History, List, TestTube } from 'lucide-react';
import axios from 'axios';

// Simple file uploader without react-dropzone
const SimpleFileUploader: React.FC<{
  onScanComplete: () => void;
}> = ({ onScanComplete }) => {
  const [scanning, setScanning] = useState(false);
  const [scanResult, setScanResult] = useState<any>(null);
  const [error, setError] = useState<string | null>(null);
  const [dragActive, setDragActive] = useState(false);

  const handleFile = async (file: File) => {
    const maxSize = 100 * 1024 * 1024;
    if (file.size > maxSize) {
      setError(`File too large. Maximum size is ${maxSize / 1024 / 1024}MB`);
      return;
    }

    setScanning(true);
    setError(null);
    setScanResult(null);

    try {
      const token = localStorage.getItem('token');
      
      if (!token) {
        setError('Not authenticated. Please login again.');
        setScanning(false);
        return;
      }

      const formData = new FormData();
      formData.append('file', file);

      console.log('Uploading file:', file.name, 'Size:', file.size);
      
      const response = await axios.post(
        '/api/malware/scan',
        formData,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'multipart/form-data',
          },
        }
      );

      console.log('Scan result:', response.data);
      setScanResult(response.data);
      onScanComplete();
    } catch (err: any) {
      console.error('Scan error:', err);
      const errorMsg = err.response?.data?.detail || err.message || 'Failed to scan file';
      setError(errorMsg);
    } finally {
      setScanning(false);
    }
  };

  const handleDrag = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    if (e.type === 'dragenter' || e.type === 'dragover') {
      setDragActive(true);
    } else if (e.type === 'dragleave') {
      setDragActive(false);
    }
  };

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setDragActive(false);
    
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      handleFile(e.dataTransfer.files[0]);
    }
  };

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    e.preventDefault();
    if (e.target.files && e.target.files[0]) {
      handleFile(e.target.files[0]);
    }
  };

  const getThreatColor = (level: string) => {
    switch (level?.toLowerCase()) {
      case 'critical': return 'text-red-500';
      case 'high': return 'text-orange-500';
      case 'medium': return 'text-yellow-500';
      case 'low': return 'text-blue-500';
      case 'clean': return 'text-green-500';
      default: return 'text-gray-500';
    }
  };

  const getThreatBg = (level: string) => {
    switch (level?.toLowerCase()) {
      case 'critical': return 'bg-red-500/10 border-red-500/30';
      case 'high': return 'bg-orange-500/10 border-orange-500/30';
      case 'medium': return 'bg-yellow-500/10 border-yellow-500/30';
      case 'low': return 'bg-blue-500/10 border-blue-500/30';
      case 'clean': return 'bg-green-500/10 border-green-500/30';
      default: return 'bg-gray-500/10 border-gray-500/30';
    }
  };

  return (
    <div className="space-y-6">
      <form onDragEnter={handleDrag} onSubmit={(e) => e.preventDefault()}>
        <input
          type="file"
          id="file-upload"
          onChange={handleChange}
          className="hidden"
          disabled={scanning}
        />
        <label
          htmlFor="file-upload"
          className={`block border-2 border-dashed rounded-lg p-12 text-center cursor-pointer transition-all ${
            dragActive
              ? 'border-primary-gold bg-primary-gold/5'
              : scanning
              ? 'border-muted bg-muted/5 cursor-not-allowed'
              : 'border-border hover:border-primary-gold hover:bg-primary-gold/5'
          }`}
          onDragEnter={handleDrag}
          onDragLeave={handleDrag}
          onDragOver={handleDrag}
          onDrop={handleDrop}
        >
          <div className="flex flex-col items-center gap-4">
            {scanning ? (
              <>
                <Shield className="w-16 h-16 text-primary-gold animate-pulse" />
                <p className="text-lg font-medium">Scanning file...</p>
                <p className="text-sm text-muted-foreground">
                  YARA engine is analyzing for malware signatures
                </p>
              </>
            ) : (
              <>
                <Upload className="w-16 h-16 text-primary-gold" />
                <div>
                  <p className="text-lg font-medium mb-2">
                    {dragActive ? 'Drop file here' : 'Drag & drop file to scan'}
                  </p>
                  <p className="text-sm text-muted-foreground">
                    or click to browse (max 100MB)
                  </p>
                </div>
              </>
            )}
          </div>
        </label>
      </form>

      {error && (
        <div className="bg-destructive/10 border border-destructive/30 rounded-lg p-4">
          <p className="font-medium text-destructive">Scan Error</p>
          <p className="text-sm text-destructive/80 mt-1">{error}</p>
        </div>
      )}

      {scanResult && (
        <div className="space-y-6">
          <div className={`rounded-lg p-6 border ${getThreatBg(scanResult.threat_level)}`}>
            <div className="flex items-start justify-between mb-4">
              <div>
                <h3 className="text-xl font-bold">
                  {scanResult.is_malicious ? 'Malware Detected' : 'File Clean'}
                </h3>
                <p className="text-sm text-muted-foreground mt-1">
                  {scanResult.file_name} ({(scanResult.file_size / 1024).toFixed(2)} KB)
                </p>
              </div>
              <div className={`text-2xl font-bold ${getThreatColor(scanResult.threat_level)}`}>
                {scanResult.threat_level?.toUpperCase()}
              </div>
            </div>

            {scanResult.matches?.length > 0 && (
              <div className="bg-background/50 rounded-lg p-4 mt-4">
                <p className="font-medium mb-3">
                  {scanResult.matches.length} YARA Rule{scanResult.matches.length > 1 ? 's' : ''} Matched
                </p>
                <div className="space-y-2">
                  {scanResult.matches.map((match: any, idx: number) => (
                    <div key={idx} className="bg-background/70 rounded p-3 border border-border/50">
                      <p className="font-medium text-primary-gold">{match.rule_name}</p>
                      <p className="text-sm text-muted-foreground mt-1">{match.description}</p>
                      <div className="flex gap-2 mt-2">
                        <span className="text-xs px-2 py-1 rounded bg-primary-gold/10 text-primary-gold">
                          {match.severity?.toUpperCase()}
                        </span>
                        <span className="text-xs px-2 py-1 rounded bg-muted text-muted-foreground">
                          {match.malware_type}
                        </span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          <div className="bg-card rounded-lg p-6 border border-border">
            <h4 className="font-semibold mb-4">File Hashes</h4>
            <div className="space-y-3 text-sm">
              <div className="grid grid-cols-[80px_1fr] gap-4">
                <span className="text-muted-foreground">MD5:</span>
                <code className="font-mono bg-background/50 px-2 py-1 rounded">{scanResult.md5_hash}</code>
              </div>
              <div className="grid grid-cols-[80px_1fr] gap-4">
                <span className="text-muted-foreground">SHA1:</span>
                <code className="font-mono bg-background/50 px-2 py-1 rounded">{scanResult.sha1_hash}</code>
              </div>
              <div className="grid grid-cols-[80px_1fr] gap-4">
                <span className="text-muted-foreground">SHA256:</span>
                <code className="font-mono bg-background/50 px-2 py-1 rounded break-all">{scanResult.sha256_hash}</code>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export const MalwareScannerPage: React.FC = () => {
  const [activeTab, setActiveTab] = useState<'upload' | 'history' | 'rules'>('upload');
  const [refreshKey, setRefreshKey] = useState(0);
  const [testing, setTesting] = useState(false);
  const [testResult, setTestResult] = useState<string | null>(null);

  const testEICAR = async () => {
    setTesting(true);
    setTestResult(null);
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        setTestResult('ERROR: Not authenticated. Please login again.');
        setTesting(false);
        return;
      }
      
      const response = await axios.get('/api/malware/test-eicar', {
        headers: { Authorization: `Bearer ${token}` },
      });
      
      if (response.data.is_malicious) {
        const matchCount = response.data.matches?.length || 0;
        setTestResult(`PASS: EICAR detected! (${matchCount} rules matched)`);
      } else {
        setTestResult('FAIL: EICAR not detected');
      }
      setRefreshKey(prev => prev + 1);
    } catch (error: any) {
      console.error('EICAR test error:', error);
      const errorMsg = error.response?.data?.detail || error.message || 'Unknown error';
      setTestResult(`ERROR: ${errorMsg}`);
    } finally {
      setTesting(false);
    }
  };

  return (
    <div className="flex h-screen bg-background overflow-hidden">
      <Sidebar />
      
      <main className="flex-1 ml-64 overflow-y-auto">
        <div className="p-8">
          {/* Header */}
          <div className="mb-8">
            <div className="flex items-center gap-3 mb-2">
              <Shield className="w-8 h-8 text-primary-gold" />
              <h1 className="text-3xl font-bold text-gradient-gold">Malware Scanner</h1>
            </div>
            <p className="text-muted-foreground">
              YARA-based malware detection with 11 signature rules
            </p>
          </div>

          {/* Stats */}
          <div className="mb-8">
            <MalwareStats key={refreshKey} />
          </div>

          {/* Test EICAR Button */}
          <div className="mb-6">
            <button
              onClick={testEICAR}
              disabled={testing}
              className="flex items-center gap-2 px-4 py-2 bg-primary-gold/10 hover:bg-primary-gold/20 text-primary-gold rounded-lg transition-all disabled:opacity-50"
            >
              <TestTube className="w-4 h-4" />
              {testing ? 'Testing...' : 'Test EICAR Detection'}
            </button>
            {testResult && (
              <p className={`mt-2 text-sm ${testResult.startsWith('PASS') ? 'text-green-500' : 'text-red-500'}`}>
                {testResult}
              </p>
            )}
          </div>

          {/* Tabs */}
          <div className="flex gap-2 mb-6 border-b border-border">
            <button
              onClick={() => setActiveTab('upload')}
              className={`flex items-center gap-2 px-4 py-2 font-medium transition-all ${
                activeTab === 'upload'
                  ? 'text-primary-gold border-b-2 border-primary-gold'
                  : 'text-muted-foreground hover:text-foreground'
              }`}
            >
              <Upload className="w-4 h-4" />
              Upload & Scan
            </button>
            <button
              onClick={() => setActiveTab('history')}
              className={`flex items-center gap-2 px-4 py-2 font-medium transition-all ${
                activeTab === 'history'
                  ? 'text-primary-gold border-b-2 border-primary-gold'
                  : 'text-muted-foreground hover:text-foreground'
              }`}
            >
              <History className="w-4 h-4" />
              Scan History
            </button>
            <button
              onClick={() => setActiveTab('rules')}
              className={`flex items-center gap-2 px-4 py-2 font-medium transition-all ${
                activeTab === 'rules'
                  ? 'text-primary-gold border-b-2 border-primary-gold'
                  : 'text-muted-foreground hover:text-foreground'
              }`}
            >
              <List className="w-4 h-4" />
              YARA Rules
            </button>
          </div>

          {/* Content */}
          <div>
            {activeTab === 'upload' && (
              <SimpleFileUploader onScanComplete={() => setRefreshKey(prev => prev + 1)} />
            )}
            {activeTab === 'history' && (
              <MalwareScanHistory key={refreshKey} />
            )}
            {activeTab === 'rules' && (
              <YARARulesList />
            )}
          </div>
        </div>
      </main>
    </div>
  );
};

const YARARulesList: React.FC = () => {
  const [rules, setRules] = React.useState<any[]>([]);
  const [loading, setLoading] = React.useState(true);

  React.useEffect(() => {
    const fetchRules = async () => {
      try {
        const token = localStorage.getItem('token');
        const response = await axios.get('/api/malware/rules', {
          headers: { Authorization: `Bearer ${token}` },
        });
        setRules(response.data.rules || []);
      } catch (error) {
        console.error('Failed to fetch rules:', error);
      } finally {
        setLoading(false);
      }
    };
    fetchRules();
  }, []);

  if (loading) return <div className="text-center py-12">Loading rules...</div>;

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
      {rules.map((rule, idx) => (
        <div key={idx} className="bg-card rounded-lg p-4 border border-border">
          <h3 className="font-medium text-primary-gold mb-2">{rule.rule_name}</h3>
          <p className="text-sm text-muted-foreground">{rule.description || 'No description'}</p>
          <div className="flex gap-2 mt-3">
            {rule.severity && (
              <span className="text-xs px-2 py-1 rounded bg-primary-gold/10 text-primary-gold">
                {rule.severity.toUpperCase()}
              </span>
            )}
            {rule.malware_type && (
              <span className="text-xs px-2 py-1 rounded bg-muted text-muted-foreground">
                {rule.malware_type}
              </span>
            )}
          </div>
        </div>
      ))}
    </div>
  );
};
