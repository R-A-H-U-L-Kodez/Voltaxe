# Test Environment Configuration

This file documents the environment variables used by Voltaxe test scripts for flexible configuration across different environments (local development, Docker, CI/CD).

## Environment Variables

### API URLs

| Variable | Default | Description | CI/CD Example |
|----------|---------|-------------|---------------|
| `BASE_URL` | `http://localhost:3000` | Frontend application URL | `http://frontend:3000` |
| `API_URL` | `http://localhost:8000` | Backend API URL (test_malware_scanner.py) | `http://voltaxe_api:8000` |
| `API_BASE` | `http://localhost:8000` | Backend API URL (test_cve_performance.py, populate_sample_data.py) | `http://voltaxe_api:8000` |
| `FRONTEND_URL` | `http://localhost:5173` | Frontend UI URL for display in scripts | `http://frontend:5173` |

### Test Credentials

| Variable | Default | Description |
|----------|---------|-------------|
| `TEST_USER_EMAIL` | `admin@voltaxe.com` | Test user email for E2E tests |
| `TEST_USER_PASSWORD` | `admin123` | Test user password for E2E tests |

---

## Usage Examples

### Local Development (Default)

No environment variables needed - tests use localhost defaults:

```bash
# Run E2E tests locally
npx playwright test

# Run Python test scripts locally
python3 tests/test_malware_scanner.py
python3 tests/test_cve_performance.py
python3 tests/populate_sample_data.py
```

### Docker Compose Environment

Set variables to use service names defined in docker-compose.yml:

```bash
# Run E2E tests against Docker services
export BASE_URL=http://frontend:3000
export API_URL=http://voltaxe_api:8000
npx playwright test

# Run Python tests against Docker services
export API_BASE=http://voltaxe_api:8000
export FRONTEND_URL=http://frontend:5173
python3 tests/test_malware_scanner.py
```

### GitHub Actions CI/CD

Example GitHub Actions workflow configuration:

```yaml
name: E2E Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: voltaxe_clarity_hub_test
          POSTGRES_USER: voltaxe_admin
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      voltaxe_api:
        image: voltaxe/api:latest
        env:
          DATABASE_URL: postgresql://voltaxe_admin:test_password@postgres:5432/voltaxe_clarity_hub_test
        ports:
          - 8000:8000
      
      frontend:
        image: voltaxe/frontend:latest
        env:
          VITE_API_URL: http://voltaxe_api:8000
        ports:
          - 3000:3000
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install Playwright
        run: |
          npm install -D @playwright/test
          npx playwright install
      
      - name: Run E2E Tests
        env:
          BASE_URL: http://frontend:3000
          TEST_USER_EMAIL: admin@voltaxe.com
          TEST_USER_PASSWORD: admin123
        run: npx playwright test
      
      - name: Run Python Tests
        env:
          API_BASE: http://voltaxe_api:8000
          API_URL: http://voltaxe_api:8000
          FRONTEND_URL: http://frontend:5173
        run: |
          pip install requests
          python3 tests/test_malware_scanner.py
          python3 tests/test_cve_performance.py
```

### GitLab CI Example

```yaml
test:
  image: mcr.microsoft.com/playwright:v1.40.0-focal
  services:
    - name: postgres:15
      alias: postgres
    - name: voltaxe/api:latest
      alias: voltaxe_api
    - name: voltaxe/frontend:latest
      alias: frontend
  variables:
    BASE_URL: "http://frontend:3000"
    API_URL: "http://voltaxe_api:8000"
    API_BASE: "http://voltaxe_api:8000"
    FRONTEND_URL: "http://frontend:5173"
    DATABASE_URL: "postgresql://voltaxe_admin:test_password@postgres:5432/voltaxe_clarity_hub_test"
  script:
    - npm install -D @playwright/test
    - npx playwright test
    - python3 tests/test_malware_scanner.py
```

---

## Modified Files

The following test files have been updated to use environment variables:

1. **tests/e2e/voltaxe.spec.js**
   - `BASE_URL` - Frontend URL
   - `TEST_USER_EMAIL` - Test user email
   - `TEST_USER_PASSWORD` - Test user password

2. **tests/test_malware_scanner.py**
   - `API_URL` - Backend API URL

3. **tests/test_cve_performance.py**
   - `API_BASE` - Backend API URL
   - `FRONTEND_URL` - Frontend URL (for display)

4. **tests/populate_sample_data.py**
   - `API_BASE` - Backend API URL
   - `FRONTEND_URL` - Frontend URL (for display)

---

## Backward Compatibility

All changes maintain backward compatibility:
- ✅ Default values use `localhost` for local development
- ✅ No configuration required for existing workflows
- ✅ Environment variables are optional overrides
- ✅ Existing local development workflows unaffected

---

## Testing Different Configurations

### Test Local Configuration

```bash
# Should work without any environment variables
npx playwright test
python3 tests/test_malware_scanner.py
```

### Test Docker Configuration

```bash
# Set variables and run
export BASE_URL=http://localhost:3000
export API_URL=http://localhost:8000
npx playwright test
python3 tests/test_malware_scanner.py
```

### Test CI/CD Configuration

```bash
# Simulate CI/CD environment
export BASE_URL=http://frontend:3000
export API_URL=http://voltaxe_api:8000
export API_BASE=http://voltaxe_api:8000
export FRONTEND_URL=http://frontend:5173

# Run tests
npx playwright test
python3 tests/test_malware_scanner.py
python3 tests/test_cve_performance.py
```

---

## Troubleshooting

### Tests fail with "Connection refused"

**Cause**: Service URL doesn't match actual hostname

**Solution**: Verify environment variables match your deployment:

```bash
# Local development
echo $BASE_URL  # Should be http://localhost:3000 or unset

# Docker Compose
echo $BASE_URL  # Should match service name: http://frontend:3000

# CI/CD
echo $BASE_URL  # Should match service/container name
```

### Tests timeout waiting for services

**Cause**: Services not fully started before tests run

**Solution**: Add health checks and wait conditions in CI/CD:

```yaml
services:
  voltaxe_api:
    options: >-
      --health-cmd "curl -f http://localhost:8000/health || exit 1"
      --health-interval 10s
      --health-timeout 5s
      --health-retries 5
```

---

## Best Practices

1. **Use service names in CI/CD**: Never use `localhost` in containerized environments
2. **Set explicit timeouts**: Network latency may be higher in CI/CD
3. **Health checks first**: Ensure services are ready before running tests
4. **Log configuration**: Print URLs at test start for debugging
5. **Consistent naming**: Use same service names across docker-compose and CI/CD

---

**Related Documentation**:
- `docs/HARDCODED_URLS_FIX.md` - Detailed fix documentation
- `.github/workflows/e2e-tests.yml` - GitHub Actions workflow (if exists)
- `docker-compose.yml` - Service name definitions
